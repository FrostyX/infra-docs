.. title: Fedora Infrastructure DRBD
.. slug: infra-drbd
.. date: 2012-08-23
.. taxonomy: Contributors/Infrastructure

DRBD (Distributed Replicated Block Device) is used on a few infrastructure machines
to sync data between a pair of instances. The secondary node has a bit for bit copy 
of all the data that the primary node had. In the event of failure of the primary
node, services can be enabled on the secondary node with no data loss. 

History: 

drbd support has been merged in the mainstream kernel as of 2.6.33. 
It's not backported or included in rhel6: 
https://bugzilla.redhat.com/show_bug.cgi?id=585309
So, we must use some kmod packages. 

Information: 

drbd has a kernel module and a command line util (drbdadm). If the kernel module
is loaded you can 'cat /proc/drbd' to see the current status. It should show 
something like this on a primary node: 

version: 8.3.11 (api:88/proto:86-96)
GIT-hash: 0de839cee13a4160eed6037c4bddd066645e23c5 build by dag@Build64R6, 2011-08-08 08:54:05

 1: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r---d-
    ns:215957500 nr:0 dw:61166976 dr:154812169 al:25607 bm:9600 lo:0 pe:0 ua:0 ap:0 ep:1 wo:b oos:0

If the nodes are syncing, the progress is shown here. 
If no nodes are primary, it will say 'Secondary/Seconday'. 

drbdadm is used to change parameters like sync speed, or to change 
a node from Secondary to primary, or force a resync. See 'man drbdadm' for more. 

Configuration for drbd is in /etc/drbd.conf on both nodes. This tells it what ip's 
and ports to use and what resources are called and what backing block device is used. 

'drbdoverview' also provides a one line overview of each resource. 

Common tasks: 

1. Switching which node is primary: 

Make sure to umount any mounted resources. 
On the current primary node: 'drbdadm secondary r0' 
On the current secondary node: 'drbdadm primary r0'
Mount resource on new primary node. 

2. Change the sync speed: 

drbdsetup /dev/drbd1 syncer -r 50M

will change the max speed to 50MB/sec

Resources:

http://www.drbd.org/users-guide/p-intro.html

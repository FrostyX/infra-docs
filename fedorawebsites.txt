.. title: Websites Release SOP
.. slug: infra-websites
.. date: 2015-02-20
.. taxonomy: Contributors/Infrastructure

Webites Release SOP

  * 1. Preparing the website for a release

    * 1.1 Obsolete GPG key of the EOL Fedora release
    * 1.2 Update GPG key
      * 1.2.1 Steps

  * 2. Update website

    * 2.1 For Alpha
    * 2.2 For Beta
    * 2.3 For GA

  * 3. Fire in the hole

  * 4. Tips

    * 4.1 Creating Branches
    * 4.2 Checking Out Branch
    * 4.3 Merging branches

  1. Preparing the website for a new release cycle

    1.1 Obsolete GPG key

    One month after a Fedora release the release number 'FXX-2' (i.e. 1 month
    after F21 release, F19 will be EOL) will be EOL (End of Life).
    At this point we should drop the GPG key from the list in verify/ and move
    the keys to the obsolete keys page in keys/obsolete.html.

    1.2 Update GPG key

    After another couple of weeks and as the next release approaches, watch
    the fedora-release package for a new key to be added. Use the update-gpg-keys
    script in the fedora-web git repository to add it to static/. Manually add it
    to /keys and /verify.

      1.2.1 Steps

      a) Get a copy of the new key(s) from the fedora-release repo, you will
         find FXX-primary and FXX-secondary keys. Save them in ./tools to make the
         update easier.

         https://git.fedorahosted.org/cgit/fedora-repos.git/tree/

      b) Start by editing ./tools/update-gpg-keys and adding the key-ids of
         any obsolete keys to the obsolete_keys list.

      c) Then run that script to add the new key(s) to the fedora.gpg block:

         fedora-web git:(master) cd tools/
         tools git:(master) ./update-gpg-keys RPM-GPG-KEY-fedora-23-primary
         tools git:(master) ./update-gpg-keys RPM-GPG-KEY-fedora-23-secondary

         This will add the key(s) to the keyblock in static/fedora.gpg and
         create a text file for the key in static/$KEYID.txt as well. Verify
         that these files have been created properly and contain all the keys
         that they should.

         * Handy checks: gpg static/fedora.gpg or gpg static/$KEYID.txt
         * Adding "--with-fingerprint" option will add the fingerprint to the
           output

         The output of fedora.gpg should contain only the actual keys, not the
         obsolete keys.
         The single text files should contain the correct information for the
         uploaded key.

      d) Next, add new key(s) to the list in data/verify.html and move the new
         key informations in the keys page in data/content/keys/index.html. A
         script to aid in generating the HTML code for new keys is in
         ./tools/make-gpg-key-html.
         It will print HTML to stdout for each RPM-GPG-KEY-* file given as
         arguments. This is suitable for copy/paste (or directly importing if
         your editor supports this).
         Check the copied HTML code and select if the key info is for a primary
         or secondary key (output says 'Primary or Secondary').

         tools git:(master) ./make-gpg-key-html RPM-GPG-KEY-fedora-23-primary

         Build the website with 'make en test' and carefully verify that the
         data is correct. Please double check all keys in http://localhost:5000/en/keys
         and http://localhost:5000/en/verify.

  2. Update website

    2.1 For Alpha

      a) Create the fXX-alpha branch from master
         fedora-web git:(master) git push origin master:refs/heads/f22-alpha

         and checkout to the new branch:
         fedora-web git:(master) git checkout -t -b f13-alpha origin/f13-alpha

      b) Update the global variables
         Change curr_state to Alpha for all arches

      c) Add Alpha banner
         Upload the FXX-Alpha banner to static/images/banners/f22alpha.png
         which should appear in every ${PRODUCT}/download/index.html page.

      d) Check all Download links and paths in ${PRODUCT}/prerelease/index.html
         You can find all paths in bapp01 (sudo su - mirrormanager first) or
         you can look at the downlaod page http://dl.fedoraproject.org/pub/alt/stage

      e) Add CHECKSUM files to static/checksums and verify that the paths are
         correct. The files should be in bapp01 and you can query them with:
         $ find /pub/fedora/linux/releases/test/17-Alpha/ -type f -name \
         *CHECKSUM* -exec cp '{}' . \;

      f) Add EC2 AMI IDs for Alpha. You need to add the IDs in
         data/content/cloud/prerelease/index.html.
         Once done also update the redirect paths we need to track the clicks
         on Infra. The paths are in the ./build.d/globalvar.py.

      g) Add CHECKSUM files also to http://spins.fedoraproject.org in
         static/checksums. Verify the paths are correct in data/content/verify.html.
         (see point e) to query them on bapp01)

      h) Verify all paths and links on http://spins.fedoraproject.org.

      i) Update Alpha Image sizes and pre_cloud_composedate in ./build.d/globalvar.py.
         Verify they are right in Cloud images and Docker image.

      j) Update the new POT file and push it to Zanata (ask a maintainer to do
         so)

      k) Add this build to stg.fedoraproject.org (puppet syncStatic.sh.stg) to
         test the pages online.

      l) Release Date:
        * Merge the fXX-alpha branch to master and correct conflicts manually
        * Remove the redirect of prerelease pages in puppet, edit:
        * modules/fedora-web/files/redirects.conf
        * When ready and about 90 minutes before Release Time push to master
        * Tag the commit as new release and push it too:
          $ git tag -a FXX-Alpha -m 'Releasing Fedora XX Alpha'
          $ git push --tags
        * If needed follow "Fire in the hole" below.

=====================================================================================================================
          SOP updated until this point, to be continued within the actual release cycle
=====================================================================================================================


  For Beta

    0. create the fXX-Beta branch from master

    1. add countdown banners. Could use the tools/get_counter.sh script.

    2. update the global variables (curr_state to 'Beta')

    3. test and check all links in get-fedora.html, get-prerelease.html,
       verify.html

        3.1 Ensure href's are consistent with actual filenames of mirrored
            content

            You should be able to find the paths in /pub on bapp01 (sudo
                 su - mirrormanager first)

        3.2 need link to rel-eng SOP here (RFE, doesn't exist yet)

    4. modify:

        4.1 data/content/index.html (define the release date)
        4.2 static/js/release-counter* (update dates/times, languages)

    5. remove:
          static/checksums/Fedora-XX-Alpha*

    6. add new checksums

    7. update spins.fpo and the spins category of main fpo with available
       spins. Refere to https://fedoraproject.org/wiki/Releases/20/Spins

    8. add this build on stg.fedoraproject.org (puppet syncStatic.sh.stg)

    9. The release day

	* Merge the branch fXX-Beta on master and tag it

         $ git checkout master
         $ git merge fXX-Beta
         $ git tag -a FXX-Beta -m 'Releasing Fedora XX Beta'

	* Delete the file ./fedoraproject.org/PO_FREEZE if exists on master

	* At the right time, push it then follow "Fire in the hole" bellow

  For GA

    0. Prepare the new branch

	* disable POs pulling on master: `touch ./fedoraproject.org/PO_FREEZE`
          commit this

	* `make pullpos` and commit the POs to the repo

	* create the fXX branch from master

	* delete ./fedoraproject.org/PO_FREEZE on that branch (revert previous
	  commit)

        * update the global variables (curr_state to '' and update iso_size)

        * push your commits in both branches (master an fXX). Don't forget
          that before overriding the POT in transifex as we use the same
          resource for both branches.

    1. add the newsbar in fedoraproject.org/data/content/index
       See https://fedoraproject.org/wiki/Websites/workflow/checklist#News

    2. add the release banner in static/images/banners/ 
       (see https://fedoraproject.org/wiki/F17_Artwork/Submissions/Banners)

    3. update the static/checksums/ (and remove static/checksums/Fedora-XX-Beta*)

    4. update spins.fpo and the spins category of main fpo with available
       spins. Refere to https://fedoraproject.org/wiki/Releases/20/Spins

    5. update the POT for the translators (once the slideshow content is
       updated). make pot && make pushpot

    6. add this build on stg.fedoraproject.org (puppet syncStatic.sh.stg)


    7. The release day

	* Merge the branch fXX on master and tag it

	 $ git checkout master
	 $ git merge fXX
	 $ git tag -a FXX -m 'Releasing Fedora XX'

	* Check that ./fedoraproject.org/PO_FREEZE does not exist on master

	* At the right time, push it then follow "Fire in the hole" bellow

	* Update the short links for the Cloud Images for 'Fedora XX', 'Fedora
	  XX-1' and 'Latest'
	  - Log into lockbox1 and update the
	    /puppet/manifests/services/proxy.pp file
	    accordingly.

Fire in the hole

   After 9:15 AM EDT release day, push the puppet changes (e.g.: cd ~/puppet
   && git push). This timing ensures that the cron jobs will not
   automatically push the new website before 10:00 AM. Then, on puppet1 run:

  on lockbox01: 
  
  'sudo func-command --host=proxy\* --host=bapp01\* '/usr/local/bin/run-puppet
nowait' 

   On bapp1, run:

 # Once /usr/local/bin/syncStatic on bapp1 is updated with your changes, run
 sudo -u apache /usr/local/bin/syncStatic

   This takes about 15 minutes, so try to do this well before you need to
   push the final site out.

   Finally, when releng gives the OK, run the following on the proxies to
   make the site live:

 # To sync the changes out, you can use func from puppet1 if you have sudo on
 # puppet1.
 # Otherwise, SSH to the proxies and call the below command.
 sudo /usr/bin/rsync -a --no-owner --no-group bapp01::fedoraproject.org/*
/srv/web/fedoraproject.org/

 # you probably want to do the other sites too
 sudo func-command --host=proxy\* "/usr/bin/rsync -a --no-owner --no-group
bapp1.vpn.fedoraproject.org::spins.fedoraproject.org/*
/srv/web/spins.fedoraproject.org/"
 sudo func-command --host=proxy\* "/usr/bin/rsync -a --no-owner --no-group
bapp1.vpn.fedoraproject.org::start.fedoraproject.org/*
/srv/web/start.fedoraproject.org/"

   Push commit to redirect get-prerelease to get-fedora. If you have sudo on
   puppet1, run:

  sudo func-command --host=proxy\* "/usr/bin/rsync -a --no-owner --no-group
bapp1.vpn.fedoraproject.org::fedoraproject.org/* /srv/web/fedoraproject.org/"

   Otherwise, manually run this on each proxy server:

   $ sudo /usr/bin/rsync -a --no-owner --no-group
   bapp1.vpn.fedoraproject.org::fedoraproject.org/*
   /srv/web/fedoraproject.org/

   If necessary, clear proxy caches using

   $ rm -rf /srv/cache/mod_cache/*

   Update the static banner on start.fedoraproject.org. The procedure is the
   same as with fedoraproject.org, except that the command to run on the
   proxies is

   $ sudo /usr/bin/rsync -a --no-owner --no-group
   bapp1.vpn.fedoraproject.org::start.fedoraproject.org/*
   /srv/web/start.fedoraproject.org/

Tips

  

  Merging branches

   Suggested by Ricky

 $ git merge f13-beta
 $ git checkout --theirs f13-beta [list of conflicting po files]
 $ git commit

  alpha/beta banners (static/js/banner.js)

    [
     "https://fedoraproject.org/static/images/banners/f13alpha.png",
     "Fedora 13 Alpha",
     "https://fedoraproject.org/get-prerelease",
     5
   ],

